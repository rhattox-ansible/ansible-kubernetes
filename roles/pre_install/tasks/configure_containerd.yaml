- name: Configure ContainerD with SystemdCgroup Support
  block:
    - name: "Check and prepare ContainerD configuration file"
      block:
        - name: "Check if ContainerD config file exists"
          ansible.builtin.stat:
            path: "{{ containerd_file_path }}"
          register: file_check

        - name: "Remove existing ContainerD config file if present"
          when: file_check.stat.exists
          ansible.builtin.file:
            path: "{{ containerd_file_path }}"
            state: absent

    - name: "Verify ContainerD config file status"
      ansible.builtin.stat:
        path: "{{ containerd_file_path }}"
      register: file_check

    - name: Create ContainerD configuration directory
      ansible.builtin.file:
        path: "/etc/containerd"
        state: directory
        owner: "{{ ansible_env.SUDO_USER }}"
        group: "{{ ansible_env.SUDO_USER }}"
        mode: "0750"

    - name: Generate default ContainerD configuration file
      register: generate_containerd
      changed_when: generate_containerd.rc != 0
      ansible.builtin.shell: |
        containerd config default > /etc/containerd/config.toml
      args:
        executable: /bin/bash

    - name: Enable SystemdCgroup in ContainerD configuration
      ansible.builtin.lineinfile:
        path: "{{ containerd_file_path }}"
        regexp: '^(\s*)SystemdCgroup = false'
        line: "SystemdCgroup = true"
        backup: true
      register: lineinfile_result
      changed_when: lineinfile_result.changed

    - name: Restart and enable ContainerD service
      ansible.builtin.service:
        name: containerd
        state: restarted
        enabled: true
